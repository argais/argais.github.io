<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Linuxaria Gourmet</title>
    <description>...linux, python, cloud computing, cooking, music...
</description>
    <link>//</link>
    <atom:link href="//feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Mon, 27 Jul 2015 15:08:26 -0300</pubDate>
    <lastBuildDate>Mon, 27 Jul 2015 15:08:26 -0300</lastBuildDate>
    <generator>Jekyll v2.5.3</generator>
    
      <item>
        <title>MySQL Output in Logstash</title>
        <description>&lt;h1 id=&quot;why-so-much-trouble&quot;&gt;Why so much trouble?&lt;/h1&gt;

&lt;p&gt;According to people on the #logstash IRC channel, and a bunch of searching on google, MySQL output filter isnt something easy to implement in logstash 1.4, something along the lines of “its a pain to put the jdbc/mysql driver in”.&lt;/p&gt;

&lt;p&gt;It was also said that 1.5 would change the way plugins work, making this an easier task.&lt;/p&gt;

&lt;p&gt;Well, I can’t wait that long, so I’ll hack my way around it, in a reallly roundabout way.&lt;/p&gt;

&lt;p&gt;I’ll have logstash send the processed log as json to a python/flask app that will insert that into my database.&lt;/p&gt;

&lt;p&gt;My final goal is to have my squid logs inside mysql to make a decent tool to monitor internet/bandwidth usage by user/time/ip.&lt;/p&gt;

&lt;p&gt;To make my life easier I’ll start only feeding it the source IP (the computer that made the request), destination domain and cache user (the user or computer that used the proxy).&lt;/p&gt;

&lt;h1 id=&quot;getting-started&quot;&gt;Getting started&lt;/h1&gt;

&lt;p&gt;We will add two new pieces to our ELK stack.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.mysql.com&quot;&gt;MySQL server&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://flask.pocoo.org&quot;&gt;Flask framework web app&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So in the end the entire thing will follow this path:&lt;/p&gt;

&lt;p&gt;&lt;code&gt;|--- squid server ---------------|---- logstash server ------------|
  Squid log -&amp;gt; Logstash forwarder -&amp;gt; Logstash -&amp;gt; Flask App -&amp;gt; MySQL&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;I wont be covering MySQL instalation, refer to their websites or google for it, theres plenty of guides for those.&lt;/p&gt;

&lt;p&gt;Here is the sql to create what we will be using on this guide.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;lineno&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;squid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;squid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;new_table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 3&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 4&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;VARCHAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 5&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;destination_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;VARCHAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 6&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uri_parameters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;VARCHAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 7&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source_ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;VARCHAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 8&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;response_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;BIGINT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 9&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DATETIME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;10&lt;/span&gt;   &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;KEY&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1 id=&quot;lets-get-it-done&quot;&gt;Lets get it done!&lt;/h1&gt;

&lt;p&gt;First things first, lets make an output filter on logstash, to send our logs as json to our app. So, like in the previous posts, create a new file in &lt;code&gt;/etc/logstash/conf.d/&lt;/code&gt; with the following content:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span class=&quot;lineno&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;output&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;2&lt;/span&gt;     &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;squid&amp;quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;3&lt;/span&gt; 	    &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;4&lt;/span&gt; 		    &lt;span class=&quot;n&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;json&amp;quot;&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;5&lt;/span&gt; 		    &lt;span class=&quot;n&quot;&gt;http_method&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;post&amp;quot;&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;6&lt;/span&gt; 		    &lt;span class=&quot;n&quot;&gt;url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;http://localhost:90/&amp;quot;&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;7&lt;/span&gt; 	  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;8&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;9&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This is like saying, “if the type is squid, send all the stuff as json using post to http://localhost:90”. We will be running our Flask App on port 90.&lt;/p&gt;

&lt;p&gt;Lets get flask installed.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;pip install flask&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;That was hard huh? Get the mysql stuff for python installed too, on ubuntu its:&lt;/p&gt;

&lt;p&gt;&lt;code&gt;apt-get install python-mysqldb&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Ok, now that this stuff is installed, lets get our app running, create a new file for our app.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span class=&quot;lineno&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# import the modules we will be using&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 2&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;MySQLdb&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;mysql&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 3&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;datetime&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;datetime&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 4&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;json&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 5&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;flask&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Flask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;render_template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jsonify&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make_response&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 6&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Flask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__name__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 7&lt;/span&gt; 
&lt;span class=&quot;lineno&quot;&gt; 8&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# when we get a POST or PUT on / do this...&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt; 9&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;@app.route&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;methods&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PUT&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;POST&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_json_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;11&lt;/span&gt; 	&lt;span class=&quot;c&quot;&gt;# put the json data in a variable&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;12&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;force&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;13&lt;/span&gt; 
&lt;span class=&quot;lineno&quot;&gt;14&lt;/span&gt; 	&lt;span class=&quot;c&quot;&gt;# connect to mysql&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;15&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;root&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passwd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;root&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;squid&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;16&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;cursor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cursor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;17&lt;/span&gt; 
&lt;span class=&quot;lineno&quot;&gt;18&lt;/span&gt; 	&lt;span class=&quot;c&quot;&gt;# get the values into variables, changing them to strings or ints whenever needed&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;19&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;cache_user&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;20&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;destination_host&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;dst_host&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;21&lt;/span&gt; 	&lt;span class=&quot;c&quot;&gt;# some requests dont have an uri_param field, but we still want them, so, if theres no uri_param key on the json data, make the variable empty&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;22&lt;/span&gt; 	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;has_key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;uri_param&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;23&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;uri_parameters&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;uri_param&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;24&lt;/span&gt;     &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;25&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;uri_parameters&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;26&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;source_ip&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;src_ip&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;27&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;response_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;response_size&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;28&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;# format the timestamp data into a format that isnt a royal pain to work with&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;29&lt;/span&gt; 	&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;datetime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fromtimestamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;timestamp&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strftime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;%Y-%m-&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%d&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; %H:%M:%S&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;30&lt;/span&gt; 
&lt;span class=&quot;lineno&quot;&gt;31&lt;/span&gt;     &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;32&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;INSERT INTO squid (user,destination_host,uri_parameters,source_ip,response_size,date) VALUES (&amp;#39;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;,&amp;#39;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;,&amp;#39;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;,&amp;#39;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%d&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;,&amp;#39;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;)&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;destination_host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uri_parameters&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source_ip&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;33&lt;/span&gt; 		&lt;span class=&quot;c&quot;&gt;# insert the data in the database&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;34&lt;/span&gt; 		&lt;span class=&quot;n&quot;&gt;cursor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;35&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;36&lt;/span&gt;     &lt;span class=&quot;k&quot;&gt;except&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;37&lt;/span&gt;     	&lt;span class=&quot;c&quot;&gt;# if something breaks, rollback!&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;38&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rollback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;39&lt;/span&gt; 
&lt;span class=&quot;lineno&quot;&gt;40&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;41&lt;/span&gt;     &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;42&lt;/span&gt; 
&lt;span class=&quot;lineno&quot;&gt;43&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__name__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;44&lt;/span&gt; 	&lt;span class=&quot;c&quot;&gt;# run this on all interfaces and on port 90&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;45&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;0.0.0.0&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;90&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So what does it do? Well, basically, it opens a small webserver on port 90 that expects to receive a json formated input via post (that our logstash server will send).&lt;/p&gt;

&lt;p&gt;Then it connects to the mysql server (yeah, be wise and dont use root as login and password, mine is a temporary isolated virtual machine, so I dont really care), and inserts a new line into the squid table on the squid database (creative aint I?). If it for some reason fails, rollback the changes.&lt;/p&gt;

&lt;p&gt;Start your flask app by running&lt;/p&gt;

&lt;p&gt;&lt;code&gt;python yourfile.py&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Restart your logstash server&lt;/p&gt;

&lt;p&gt;&lt;code&gt;service logstash restart&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;TADA!&lt;/strong&gt; Squid logs into mysql!&lt;/p&gt;

&lt;h2 id=&quot;now-you-can-easily-search-group-and-make-reports-with-it&quot;&gt;Now you can easily search, group and make reports with it!&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;If you need more data from the logs you can add the fields on the database, and on the field vars and sql var, I am only collecting the bare minimum I need.&lt;/p&gt;
&lt;/blockquote&gt;
</description>
        <pubDate>Tue, 14 Oct 2014 13:22:14 -0300</pubDate>
        <link>//log_processing/2014/10/14/mysql-output-in-logstash.html</link>
        <guid isPermaLink="true">//log_processing/2014/10/14/mysql-output-in-logstash.html</guid>
        
        <category>linux</category>
        
        <category>logstash</category>
        
        <category>elasticsearch</category>
        
        <category>kibana</category>
        
        <category>devops</category>
        
        <category>mysql</category>
        
        <category>python</category>
        
        <category>flask</category>
        
        
        <category>log_processing</category>
        
      </item>
    
      <item>
        <title>Squid log filtering with ELK stack</title>
        <description>&lt;p&gt;So now that we have our ELK stack working, lets get squid logs on it!&lt;/p&gt;

&lt;p&gt;First of all install the logstash forwarder on your server like the previous post instructed you.&lt;/p&gt;

&lt;p&gt;When you get to editing the forwarder config file ( /etc/logstash-forwarder ) lets change it a bit to:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;network&quot;: {
    &quot;servers&quot;: [ &quot;logstash_server_ip:5000&quot; ],
    &quot;timeout&quot;: 15,
    &quot;ssl ca&quot;: &quot;/etc/pki/tls/certs/logstash-forwarder.crt&quot;
  },
  &quot;files&quot;: [
    {
      &quot;paths&quot;: [
        &quot;/var/log/squid/access.log&quot;
       ],
      &quot;fields&quot;: { &quot;type&quot;: &quot;squid&quot; }
    }
   ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On your logstash server lets create a new config file&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/logstash/conf.d/11-squid.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And put this in it:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;filter {
    if [type] == &quot;squid&quot; {
      grok {
          match =&amp;gt; { &quot;message&quot; =&amp;gt; &quot;%{SYSLOGTIMESTAMP:date} %{HOST:service} %{DATA:squid_instance} %{NUMBER:timestamp}\s+%{NUMBER:request_msec:int} %{IPORHOST:src_ip} %{WORD:cache_result}/%{NUMBER:response_status:int} %{NUMBER:response_size:int} %{WORD:http_method} (%{URIPROTO:http_proto}://)?%{IPORHOST:dst_host}(?::%{POSINT:port:int})?(?:%{URIPATHPARAM:uri_param})? %{DATA:cache_user} %{WORD:request_route}/(%{IPORHOST:forwarded_to}|-) %{GREEDYDATA:content_type}&quot; }
      }
      date {
          match =&amp;gt; [ &quot;timestamp&quot;, &quot;UNIX&quot; ]
      }
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Restart both logstash on your server and logstash-forwarder on your squid server.&lt;/p&gt;

&lt;p&gt;Bang error!
My server is complaining that the charset being sent is different then what was expected, so I changed the charset on my input.&lt;/p&gt;

&lt;p&gt;Edit the input file&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/logstash/conf.d/01-lumberjack-input.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And change it so it looks like&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;input {
      lumberjack {
        port =&amp;gt; 5000
        type =&amp;gt; &quot;logs&quot;
        ssl_certificate =&amp;gt; &quot;/etc/pki/tls/certs/logstash-forwarder.crt&quot;
        ssl_key =&amp;gt; &quot;/etc/pki/tls/private/logstash-forwarder.key&quot;
    	codec =&amp;gt; plain {
	    	charset =&amp;gt; &quot;ISO-8859-1&quot;
    	}
      }
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now you’re gonna tell me this &lt;strong&gt;still&lt;/strong&gt; isnt working for you.&lt;/p&gt;

&lt;p&gt;Read up on grok, and check if this filter is valid for your squid log.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;One really valueable tool is &lt;a href=&quot;http://grokdebug.herokuapp.com/&quot;&gt;grok debug&lt;/a&gt;, you feed it a line of your log, and start putting the grok filters and you can see the output, thus, validating your grok filter easily.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;If its all working, you should see something like this on the default logstash dashboard on kibana (searching for squid).&lt;/p&gt;

&lt;p&gt;[](/assets/article_images/2014-10-10-squid-log-filtering-with-elk-stack/squid-kibana-working.png)&lt;/p&gt;

&lt;p&gt;How is this usefull for monitoring squid? Well, different admins have different needs.&lt;/p&gt;

&lt;p&gt;Personally, in our company our users have unrestricted access, kind off, theres filters in squid for adult content, games, stuff that has absolutely nothing to do with work, so we want to know who got their access denied to urls, and who is using the most bandwidth.&lt;/p&gt;

&lt;p&gt;So now you have all that log data in your hands, using simple filters in kibana you can check what a specific user did in a period of time, or check when you have traffic spikes, etc etc…&lt;/p&gt;

&lt;p&gt;Have fun ;)&lt;/p&gt;

</description>
        <pubDate>Fri, 10 Oct 2014 11:05:20 -0300</pubDate>
        <link>//log_processing/2014/10/10/squid-log-filtering-with-elk-stack.html</link>
        <guid isPermaLink="true">//log_processing/2014/10/10/squid-log-filtering-with-elk-stack.html</guid>
        
        <category>linux</category>
        
        <category>logstash</category>
        
        <category>elasticsearch</category>
        
        <category>kibana</category>
        
        <category>devops</category>
        
        
        <category>log_processing</category>
        
      </item>
    
      <item>
        <title>ELK (Elasticsearch, Logstash and Kibana) Stack and Squid</title>
        <description>&lt;h1 id=&quot;intro&quot;&gt;Intro&lt;/h1&gt;

&lt;p&gt;Squid, the mean guy all users hate.
Personally, as an admin, I hate it too, but its a necessary evil.&lt;/p&gt;

&lt;p&gt;Now, checking its logs is hell, whoever devised that timestamp surelly is a mean person :(&lt;/p&gt;

&lt;p&gt;In time I will make a decent squid monitoring solution, its one of my professional goals, but for now I want a better way to look at those logs.&lt;/p&gt;

&lt;p&gt;I also want to have centralized logging and an easy way to look at those, and that brings me to the perfect excuse to go fiddle with the &lt;a href=&quot;www.elasticsearch.org&quot;&gt;ELK stack&lt;/a&gt; (Elasticsearch, Logstash, Kibana)!&lt;/p&gt;

&lt;p&gt;So how does this work?&lt;/p&gt;

&lt;p&gt;The ELK stack is composed of three components&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;E&lt;/strong&gt;lasticsearch&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;L&lt;/strong&gt;ogstash&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;K&lt;/strong&gt;ibana&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Logstash receives, and treats our logs into some format we can run a query on, it forwards them to elasticsearch (that actually stores our logs) and then we use kibana to actually run the searchs and make neat dashboards.&lt;/p&gt;

&lt;p&gt;On this post I’ll get the stack working, on a next post I’ll have it receiving squid logs.&lt;/p&gt;

&lt;h1 id=&quot;so-lets-get-our-hands-dirty&quot;&gt;So lets get our hands dirty.&lt;/h1&gt;

&lt;p&gt;I am using an ubuntu 12.04 server (ya, 14.04 is out I know…) and I’ll be following a &lt;a href=&quot;https://www.digitalocean.com/community/tutorials/how-to-use-logstash-and-kibana-to-centralize-and-visualize-logs-on-ubuntu-14-04&quot;&gt;guide from the awesome people at Digital Ocean&lt;/a&gt;. I absolutely recomend people to read this link, I am basing my lil guide on it, but changing things to make more sense to me here and there.&lt;/p&gt;

&lt;h1 id=&quot;get-your-java&quot;&gt;Get your java&lt;/h1&gt;

&lt;p&gt;&lt;strong&gt;Use sudo wherever its needed&lt;/strong&gt;, I am doing all this as root, because I’m fidling with a test environment, be a good admin and use sudo on production servers.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;add-apt-repository -y ppa:webupd8team/java
apt-get update
apt-get -y install oracle-java7-installer
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;add-elasticity-to-your-search&quot;&gt;Add elasticity to your search&lt;/h1&gt;

&lt;p&gt;Get it done!&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;wget -O - http://packages.elasticsearch.org/GPG-KEY-elasticsearch |  apt-key add -
echo &#39;deb http://packages.elasticsearch.org/elasticsearch/1.1/debian stable main&#39; | tee /etc/apt/sources.list.d/elasticsearch.list
apt-get update
apt-get -y install elasticsearch=1.1.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With that done lets edit elasticsearch’s configuration file&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/elasticsearch/elasticsearch.yml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We will change two lines, one to disable dynamic scripts, and the second to restrict access to our elasticsearch instance to localhost only, so people can’t shutdown our shinny new toy using the HTTP API.&lt;/p&gt;

&lt;p&gt;So, add this line:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;script.disable_dynamic: true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then uncomment and edit this one (comes with 192.168.0.1 instead of localhost):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;network.host: localhost
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(markdown is awesome, so easy to write blog posts these days…)&lt;/p&gt;

&lt;p&gt;Save the file and start elasticsearch.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;service elasticsearch restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lets have it up on boot (doing as the installer tells us)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;update-rc.d elasticsearch defaults 95 10 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Woot! our searchs are elastic now (yup, I’m in a dad joke/pun mood today)&lt;/p&gt;

&lt;h1 id=&quot;rev-up-your-nginx&quot;&gt;Rev up your Ngin…X&lt;/h1&gt;

&lt;p&gt;Kibana sits on a webserver, my test box has none installed, I love nginx, and the original guide on Digital Ocean uses it too, so lets go with it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install nginx
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Damn this was hard. Kibana connects to Elasticsearch on port 9200, we connect to the webserver on port 80, nginx needs to proxy the requests from 80 -&amp;gt; 9200.&lt;/p&gt;

&lt;p&gt;If you’re familiar with nginx this should be trivial, but since the Kibana guys are so nice we will get a sample config from their github repo.&lt;/p&gt;

&lt;p&gt;Get into a temp folder and download it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;wget https://github.com/elasticsearch/kibana/raw/master/sample/nginx.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Edit it&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi nginx.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lets change the following lines to look like this&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;server_name localhost;
root /usr/share/nginx/kibana;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Save it, and lets overwrite the default nginx&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cp nginx.conf /etc/nginx/sites-available/default
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Restart nginx&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;service nginx restart
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;install-kibana-failed-to-think-of-a-crappy-pun&quot;&gt;Install Kibana (failed to think of a crappy pun)&lt;/h1&gt;

&lt;p&gt;Get into a temp folder and download Kibana, then unpack the file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;wget https://download.elasticsearch.org/kibana/kibana/kibana-3.0.1.tar.gz
tar zxvf kibana-3.0.1.tar.gz
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Edit its configuration&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi kibana-3.0.1/config.js
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the elasticsearch line change it to use port 80 (from 9200).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;elasticsearch: &quot;http://&quot;+window.location.hostname+&quot;:80&quot;,
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lets rename and move our folder to the place we previously specified in the nginx conf file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mv kibana-3.0.1 kibana
mv kibana /usr/share/nginx/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now you should be able to see your kibana interface when trying to access http://your_server_ip/.&lt;/p&gt;

&lt;p&gt;If all went well you should be greeted by this nice interface.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/article_images/2014-10-05-ELK-Stack-and-Squid/kibana.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I am not setting up any kind of login screen at this time, we will get to it at the end of this guide (gotta get things working first :D)&lt;/p&gt;

&lt;h1 id=&quot;certificates&quot;&gt;Certificates&lt;/h1&gt;

&lt;p&gt;We will be using Logstash Forwarder to send the logs from our servers to the logstash server, so we will need to create some certificates (yay -_-) those will be used by the forwarder to verify the identity of the logstash server, I like to think of certificates as photo ids :D.&lt;/p&gt;

&lt;p&gt;Lets make the folders to store the certs and create then in the correct place.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir -p /etc/pki/tls/certs
mkdir /etc/pki/tls/private
cd /etc/pki/tls
openssl req -x509 -batch -nodes -days 3650 -newkey rsa:2048 -keyout private/logstash-forwarder.key -out certs/logstash-forwarder.crt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Later we will copy this cert to all the servers that send logs to logstash.&lt;/p&gt;

&lt;h1 id=&quot;a-stash-for-our-logs&quot;&gt;A stash for our logs&lt;/h1&gt;

&lt;p&gt;Installing logstash is mad easy, so get it done&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;echo &#39;deb http://packages.elasticsearch.org/logstash/1.4/debian stable main&#39; | tee /etc/apt/sources.list.d/logstash.list
apt-get update
apt-get install logstash=1.4.2-1-2c0f5a1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, its installed, now to configure it.&lt;/p&gt;

&lt;p&gt;So, logstash conf files are separated in inputs, filters and outputs.&lt;/p&gt;

&lt;p&gt;Inputs will describe how the server will receive the logs.
Filters will get your cryptic log lines and change into something you can search later.
Output will describe where the filtered info will be sent to.&lt;/p&gt;

&lt;p&gt;Let’s go ahead and setup a lumberjack input, lumberjack is the protocol logstash forwarder uses.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/logstash/conf.d/01-lumberjack-input.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then insert this configuration:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;input {
  lumberjack {
    port =&amp;gt; 5000
    type =&amp;gt; &quot;logs&quot;
    ssl_certificate =&amp;gt; &quot;/etc/pki/tls/certs/logstash-forwarder.crt&quot;
    ssl_key =&amp;gt; &quot;/etc/pki/tls/private/logstash-forwarder.key&quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What is this doing? the file says it all, we are setting up a lumberjack input in port 5000(tcp), and it will use the ssl cert we created before.&lt;/p&gt;

&lt;p&gt;Now lets create a new file where we will add a filter for syslog messages (syslog, the megalogfile :P).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/logstash/conf.d/10-syslog.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Insert this filter conf:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;filter {
  if [type] == &quot;syslog&quot; {
    grok {
      match =&amp;gt; { &quot;message&quot; =&amp;gt; &quot;%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}&quot; }
      add_field =&amp;gt; [ &quot;received_at&quot;, &quot;%{@timestamp}&quot; ]
      add_field =&amp;gt; [ &quot;received_from&quot;, &quot;%{host}&quot; ]
    }
    syslog_pri { }
    date {
      match =&amp;gt; [ &quot;syslog_timestamp&quot;, &quot;MMM  d HH:mm:ss&quot;, &quot;MMM dd HH:mm:ss&quot; ]
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, this says that it will filter logs that have been labeled as “syslog” type by logstash forwarder, and it will use grok to parse it into something we can search on later.&lt;/p&gt;

&lt;p&gt;Now the output, once again we create a new file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/logstash/conf.d/30-lumberjack-output.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we put this in:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;output {
  elasticsearch { host =&amp;gt; localhost }
  stdout { codec =&amp;gt; rubydebug }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This tells logstash to store the logs in elasticsearch.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;If you want to setup more filters, be sure to have the conf files named between input and output ( between our 01 and 30 files ).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Restart it and…&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;service logstash restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;TADA! Its working.&lt;/p&gt;

&lt;p&gt;Now what?&lt;/p&gt;

&lt;p&gt;Now we gotta ship these logs from the servers to logstash, meaning we gotta setup logstash forwarder.&lt;/p&gt;

&lt;h1 id=&quot;ship-those-logs&quot;&gt;Ship those logs!!!&lt;/h1&gt;

&lt;p&gt;First of all, remember those ssl certs we created? Yup, gotta copy them to the servers you will have logs shipped to logstash.&lt;/p&gt;

&lt;p&gt;So I like to think I’m a smart guy (not really :P) and made a simple script (you could do this on puppet if you are actually smart ;). Remember that I’m working in a test lab, and I’m mostly interested in getting it running to check out how it works.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;When you work in production be smarter and use something like puppet to deploy this, and dont use root for everything like I’m doing, &lt;strong&gt;sudo exists for a reason&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code&gt;#!/bin/bash
mkdir -p /etc/pki/tls/certs
scp root@my_logstash_server:/etc/pki/tls/certs/logstash-forwarder.crt /etc/pki/tls/certs
echo &#39;deb http://packages.elasticsearch.org/logstashforwarder/debian stable main&#39; | tee /etc/apt/sources.list.d/logstashforwarder.list
apt-get update
apt-get install logstash-forwarder
cd /etc/init.d/
wget https://raw.github.com/elasticsearch/logstash-forwarder/master/logstash-forwarder.init -O logstash-forwarder
chmod +x logstash-forwarder
update-rc.d logstash-forwarder defaults
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There it is! Installed, now lets configure it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/logstash-forwarder
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now insert the following lines, replace logstash_server with the ip/name of your logstash server.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;network&quot;: {
    &quot;servers&quot;: [ &quot;logstash_server_private_IP:5000&quot; ],
    &quot;timeout&quot;: 15,
    &quot;ssl ca&quot;: &quot;/etc/pki/tls/certs/logstash-forwarder.crt&quot;
  },
  &quot;files&quot;: [
    {
      &quot;paths&quot;: [
        &quot;/var/log/syslog&quot;,
        &quot;/var/log/auth.log&quot;
       ],
      &quot;fields&quot;: { &quot;type&quot;: &quot;syslog&quot; }
    }
   ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, this tells the forwarder to connect on our logstash server on port 5000 (remember our server input config?), using the ssl cert.
The paths tell which logfiles to send, in this case syslog and auth.log, and the type label (remember our filter conf?).&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;If you had something like a squid server we could send the squid log files, and label then with type: somethingelse.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Restart it now:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;service logstash-forwarder restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now it is sending logs to the server.&lt;/p&gt;

&lt;h1 id=&quot;lets-use-our-new-toy&quot;&gt;Lets use our new toy!&lt;/h1&gt;

&lt;p&gt;Now that you repeated that on all the servers you want to monitor, jump to kibana (http://logstash_server_ip).&lt;/p&gt;

&lt;p&gt;There’s a link to a premade logstash dashboard.&lt;/p&gt;

&lt;p&gt;Now you should have some data popping in, use the query field to search for stuff like a username (to see if someone is hammering a username to bruteforce their way into the server), also fiddle around with the graph functions, have fun ;)&lt;/p&gt;

&lt;p&gt;![]/assets/article_images/2014-10-05-ELK-Stack-and-Squid/kibana-working.png)&lt;/p&gt;

&lt;h1 id=&quot;extra-safe&quot;&gt;Extra safe?&lt;/h1&gt;

&lt;p&gt;Since kibana doesnt have any kind of authentication, we can put a login/pass at the webserver.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install apache2-utils
htpasswd -c /etc/nginx/conf.d/kibana.myhost.org.htpasswd username
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then enter and verify the password, worry not, this file is already referenced in the nginx install we did before.
Restart nginx to apply&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;service nginx restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thats all for now, I’ll be fidling with squid logs soon and I’ll write another guide for it.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Kudos to &lt;a href=&quot;https://www.digitalocean.com/community/users/manicas&quot;&gt;Mitchell Anicas&lt;/a&gt; for the awesome guide I based this post on. By no means I claim to have done it all myself, I just rewrote it in a way thats easier for me.&lt;/p&gt;
&lt;/blockquote&gt;
</description>
        <pubDate>Sat, 04 Oct 2014 21:00:00 -0300</pubDate>
        <link>//log_processing/2014/10/04/ELK-Stack-and-Squid.html</link>
        <guid isPermaLink="true">//log_processing/2014/10/04/ELK-Stack-and-Squid.html</guid>
        
        <category>linux</category>
        
        <category>logstash</category>
        
        <category>elasticsearch</category>
        
        <category>kibana</category>
        
        <category>devops</category>
        
        
        <category>log_processing</category>
        
      </item>
    
  </channel>
</rss>
