

  
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>MySQL Output in Logstash</title>
  <meta name="description" content="...linux, python, cloud computing, cooking, music...
">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="//log_processing/2014/10/14/mysql-output-in-logstash.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css">
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css">


  
    <!-- header start -->

<a href="/" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/fb_logo.png)"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">MySQL Output in Logstash</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/avatar.png)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2014-10-14T13:22:14-03:00">14 Oct 2014</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <h1 id="why-so-much-trouble">Why so much trouble?</h1>

<p>According to people on the #logstash IRC channel, and a bunch of searching on google, MySQL output filter isnt something easy to implement in logstash 1.4, something along the lines of “its a pain to put the jdbc/mysql driver in”.</p>

<p>It was also said that 1.5 would change the way plugins work, making this an easier task.</p>

<p>Well, I can’t wait that long, so I’ll hack my way around it, in a reallly roundabout way.</p>

<p>I’ll have logstash send the processed log as json to a python/flask app that will insert that into my database.</p>

<p>My final goal is to have my squid logs inside mysql to make a decent tool to monitor internet/bandwidth usage by user/time/ip.</p>

<p>To make my life easier I’ll start only feeding it the source IP (the computer that made the request), destination domain and cache user (the user or computer that used the proxy).</p>

<h1 id="getting-started">Getting started</h1>

<p>We will add two new pieces to our ELK stack.</p>

<ul>
  <li><a href="http://www.mysql.com">MySQL server</a></li>
  <li><a href="http://flask.pocoo.org">Flask framework web app</a></li>
</ul>

<p>So in the end the entire thing will follow this path:</p>

<p><code>|--- squid server ---------------|---- logstash server ------------|
  Squid log -&gt; Logstash forwarder -&gt; Logstash -&gt; Flask App -&gt; MySQL</code></p>

<p>I wont be covering MySQL instalation, refer to their websites or google for it, theres plenty of guides for those.</p>

<p>Here is the sql to create what we will be using on this guide.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="lineno"> 1</span> <span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">squid</span><span class="p">;</span>
<span class="lineno"> 2</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">squid</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">new_table</span><span class="o">`</span> <span class="p">(</span>
<span class="lineno"> 3</span>   <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="lineno"> 4</span>   <span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
<span class="lineno"> 5</span>   <span class="o">`</span><span class="n">destination_host</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
<span class="lineno"> 6</span>   <span class="o">`</span><span class="n">uri_parameters</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
<span class="lineno"> 7</span>   <span class="o">`</span><span class="n">source_ip</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
<span class="lineno"> 8</span>   <span class="o">`</span><span class="n">response_size</span><span class="o">`</span> <span class="nb">BIGINT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="lineno"> 9</span>   <span class="o">`</span><span class="nb">date</span><span class="o">`</span> <span class="n">DATETIME</span> <span class="k">NULL</span><span class="p">,</span>
<span class="lineno">10</span>   <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">));</span></code></pre></figure>

<h1 id="lets-get-it-done">Lets get it done!</h1>

<p>First things first, lets make an output filter on logstash, to send our logs as json to our app. So, like in the previous posts, create a new file in <code>/etc/logstash/conf.d/</code> with the following content:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">output</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="k">if</span> <span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">==</span> <span class="s">"squid"</span> <span class="p">{</span>
<span class="lineno">3</span> 	    <span class="n">http</span> <span class="p">{</span>
<span class="lineno">4</span> 		    <span class="n">format</span> <span class="o">=&gt;</span> <span class="s">"json"</span>
<span class="lineno">5</span> 		    <span class="n">http_method</span> <span class="o">=&gt;</span> <span class="s">"post"</span>
<span class="lineno">6</span> 		    <span class="n">url</span> <span class="o">=&gt;</span> <span class="s">"http://localhost:90/"</span>
<span class="lineno">7</span> 	  <span class="p">}</span>
<span class="lineno">8</span>     <span class="p">}</span>
<span class="lineno">9</span> <span class="p">}</span></code></pre></figure>

<p>This is like saying, “if the type is squid, send all the stuff as json using post to http://localhost:90”. We will be running our Flask App on port 90.</p>

<p>Lets get flask installed.</p>

<p><code>pip install flask</code></p>

<p>That was hard huh? Get the mysql stuff for python installed too, on ubuntu its:</p>

<p><code>apt-get install python-mysqldb</code></p>

<p>Ok, now that this stuff is installed, lets get our app running, create a new file for our app.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="c"># import the modules we will be using</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">MySQLdb</span> <span class="kn">as</span> <span class="nn">mysql</span>
<span class="lineno"> 3</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="lineno"> 4</span> <span class="kn">import</span> <span class="nn">json</span>
<span class="lineno"> 5</span> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">make_response</span>
<span class="lineno"> 6</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="c"># when we get a POST or PUT on / do this...</span>
<span class="lineno"> 9</span> <span class="nd">@app.route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"PUT"</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">])</span>
<span class="lineno">10</span> <span class="k">def</span> <span class="nf">get_json_data</span><span class="p">():</span>
<span class="lineno">11</span> 	<span class="c"># put the json data in a variable</span>
<span class="lineno">12</span>     <span class="n">log_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> 	<span class="c"># connect to mysql</span>
<span class="lineno">15</span>     <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="s">'root'</span><span class="p">,</span><span class="n">passwd</span><span class="o">=</span><span class="s">'root'</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="s">'squid'</span><span class="p">)</span>
<span class="lineno">16</span>     <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> 	<span class="c"># get the values into variables, changing them to strings or ints whenever needed</span>
<span class="lineno">19</span>     <span class="n">user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s">'cache_user'</span><span class="p">])</span>
<span class="lineno">20</span>     <span class="n">destination_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s">'dst_host'</span><span class="p">])</span>
<span class="lineno">21</span> 	<span class="c"># some requests dont have an uri_param field, but we still want them, so, if theres no uri_param key on the json data, make the variable empty</span>
<span class="lineno">22</span> 	<span class="k">if</span> <span class="n">log_data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">'uri_param'</span><span class="p">):</span>
<span class="lineno">23</span>         <span class="n">uri_parameters</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s">'uri_param'</span><span class="p">])</span>
<span class="lineno">24</span>     <span class="k">else</span><span class="p">:</span>
<span class="lineno">25</span>         <span class="n">uri_parameters</span> <span class="o">=</span> <span class="s">''</span>
<span class="lineno">26</span>     <span class="n">source_ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s">'src_ip'</span><span class="p">])</span>
<span class="lineno">27</span>     <span class="n">response_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s">'response_size'</span><span class="p">])</span>
<span class="lineno">28</span>     <span class="c"># format the timestamp data into a format that isnt a royal pain to work with</span>
<span class="lineno">29</span> 	<span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">]))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S'</span><span class="p">)</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>     <span class="k">try</span><span class="p">:</span>
<span class="lineno">32</span>         <span class="n">sql</span> <span class="o">=</span> <span class="s">"INSERT INTO squid (user,destination_host,uri_parameters,source_ip,response_size,date) VALUES ('</span><span class="si">%s</span><span class="s">','</span><span class="si">%s</span><span class="s">','</span><span class="si">%s</span><span class="s">','</span><span class="si">%s</span><span class="s">',</span><span class="si">%d</span><span class="s">,'</span><span class="si">%s</span><span class="s">')"</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">destination_host</span><span class="p">,</span> <span class="n">uri_parameters</span><span class="p">,</span> <span class="n">source_ip</span><span class="p">,</span> <span class="n">response_size</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
<span class="lineno">33</span> 		<span class="c"># insert the data in the database</span>
<span class="lineno">34</span> 		<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="lineno">35</span>         <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="lineno">36</span>     <span class="k">except</span><span class="p">:</span>
<span class="lineno">37</span>     	<span class="c"># if something breaks, rollback!</span>
<span class="lineno">38</span>         <span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>     <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="lineno">41</span>     <span class="k">return</span> <span class="s">""</span>
<span class="lineno">42</span> 
<span class="lineno">43</span> <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
<span class="lineno">44</span> 	<span class="c"># run this on all interfaces and on port 90</span>
<span class="lineno">45</span>     <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span></code></pre></figure>

<p>So what does it do? Well, basically, it opens a small webserver on port 90 that expects to receive a json formated input via post (that our logstash server will send).</p>

<p>Then it connects to the mysql server (yeah, be wise and dont use root as login and password, mine is a temporary isolated virtual machine, so I dont really care), and inserts a new line into the squid table on the squid database (creative aint I?). If it for some reason fails, rollback the changes.</p>

<p>Start your flask app by running</p>

<p><code>python yourfile.py</code></p>

<p>Restart your logstash server</p>

<p><code>service logstash restart</code></p>

<p><strong>TADA!</strong> Squid logs into mysql!</p>

<p>##Now you can easily search, group and make reports with it!</p>

<blockquote>
  <p>If you need more data from the logs you can add the fields on the database, and on the field vars and sql var, I am only collecting the bare minimum I need.</p>
</blockquote>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=MySQL+Output+in+Logstash&amp;url=//log_processing/2014/10/14/mysql-output-in-logstash" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/avatar.png)">Blog Logo</div>
              <h4>Fernando Battistella</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2014-10-14 13:22">14 Oct 2014</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Fernando Battistella</a> © 2016<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image" style="background-image: url(/assets/images/banner.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Linuxaria Gourmet</h1>
        <h2 class="blog-description">...linux, python, cloud computing, cooking, music...
</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>


  

